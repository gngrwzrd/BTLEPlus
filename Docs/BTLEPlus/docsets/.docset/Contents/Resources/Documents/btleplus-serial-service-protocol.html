<!DOCTYPE html>
<html lang="en">
  <head>
    <title>BTLEPlus Serial Service Protocol  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>


    <a title="BTLEPlus Serial Service Protocol  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
           Docs
        </a>
         (93% documented)
      </p>
    
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html"> Reference</a>
      <img class="carat" src="img/carat.png" />
      BTLEPlus Serial Service Protocol  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Guides.html">Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="btleplus-serial-service-protocol.html">BTLEPlus Serial Service Protocol</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="btlepluscentralmanager-programming-guide.html">BTLEPlusCentralManager Programming Guide</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/BTLEAdvertisementData.html">BTLEAdvertisementData</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/BTLEPlusCentralManager.html">BTLEPlusCentralManager</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/BTLEPlusPeripheral.html">BTLEPlusPeripheral</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/BTLEPlusSerialServiceController.html">BTLEPlusSerialServiceController</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/BTLEPlusSerialServiceMessage.html">BTLEPlusSerialServiceMessage</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Global Variables.html">Global Variables</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Global Variables.html#/s:v8BTLEPlus31BTLEPlusSerialServiceDefaultMTUVs6UInt16">BTLEPlusSerialServiceDefaultMTU</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Global Variables.html#/s:v8BTLEPlus38BTLEPlusSerialServiceDefaultWindowSizeVs5UInt8">BTLEPlusSerialServiceDefaultWindowSize</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Global Variables.html#/s:v8BTLEPlus33BTLEPlusSerialServiceMaxMessageIdVs5UInt8">BTLEPlusSerialServiceMaxMessageId</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Global Variables.html#/s:v8BTLEPlus34BTLEPlusSerialServiceMaxWindowSizeVs5UInt8">BTLEPlusSerialServiceMaxWindowSize</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Enums.html">Enums</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/BTLEPlusSerialServiceRunMode.html">BTLEPlusSerialServiceRunMode</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/OptionSetType.html">OptionSetType</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/BTLEPlusCentralManagerDelegate.html">BTLEPlusCentralManagerDelegate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/BTLEPlusSerialServiceControllerDelegate.html">BTLEPlusSerialServiceControllerDelegate</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Typealiases.html">Typealiases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/s:8BTLEPlus29BTLEPlusSerialServiceMTU_Type">BTLEPlusSerialServiceMTU_Type</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/s:8BTLEPlus35BTLEPlusSerialServiceMessageId_Type">BTLEPlusSerialServiceMessageId_Type</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/s:8BTLEPlus37BTLEPlusSerialServiceMessageType_Type">BTLEPlusSerialServiceMessageType_Type</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/s:8BTLEPlus39BTLEPlusSerialServicePacketCounter_Type">BTLEPlusSerialServicePacketCounter_Type</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/s:8BTLEPlus45BTLEPlusSerialServiceProtocolMessageType_Type">BTLEPlusSerialServiceProtocolMessageType_Type</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Typealiases.html#/s:8BTLEPlus36BTLEPlusSerialServiceWindowSize_Type">BTLEPlusSerialServiceWindowSize_Type</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content">
            
            <a href='#btleplus-serial-service-protocol' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h1 id='btleplus-serial-service-protocol'>BTLEPlus Serial Service Protocol</h1>

<p>The BTLEPlus Serial Service protocol is a binary protocol used to exchange data between two BTLE peers - a central and a peripheral.</p>

<p>It&rsquo;s a turn based message system where both the central and peripheral are given turns to send their queued messages.</p>

<p><strong>MTU</strong> - Maximum transmission unit. This is negotiated when peers are connected.</p>

<p><strong>Packet</strong> - A packet is the smallest amount of data transferrable between peers. A packet&rsquo;s max size in bytes is the MTU.</p>

<p><strong>Window Size</strong> - The number of open buffers to send or receive data. Each buffer&rsquo;s size is MTU. This is negotiated when peers are connected.</p>

<p><strong>Part</strong> - A part is the entire window of bytes sent or received. This can also be less than the entire window if the message is even smaller.</p>
<a href='#protocol-control-messages' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='protocol-control-messages'>Protocol Control Messages</h2>

<p>Protocol messages are used to control the flow of data and are exchanged between the central and peripheral peers.</p>
<a href='#protocol-types' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h5 id='protocol-types'>Protocol Types</h5>
<pre class="highlight plaintext"><code>PeerInfo           = 1
Ack                = 2
NewMessage         = 3
NewFileMessage     = 4
EndPart            = 5
EndMessage         = 6
Data               = 7
Resend             = 8
TakeTurn           = 9
Abort              = 10
</code></pre>
<a href='#protocol-control-message-formats' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h5 id='protocol-control-message-formats'>Protocol Control Message Formats</h5>

<p>Protocol message fields are stored in network order - big endian.</p>

<p>Sizes are in bytes:</p>
<pre class="highlight plaintext"><code>Ack:            [protocolType:1]
PeerInfo:       [protocolType:1, mtu:2, windowSize:1]
NewMessage:     [protocolType:1, messageType:1, messageId: 1, expectedSize:8]
NewFileMessage: [protocolType:1, messageType:1, messageId: 1, expectedSize:8]
EndMessage:     [protocolType:1, endMessageWindowSize:1]
EndPart:        [protocolType:1, endPartWindowSize:1]
Resend:         [protocolType:1]
Data:           [protocolType:1, packetCount:1, data:18]
TakeTurn:       [protocolType:1]
Abort:          [protocolType:1]
</code></pre>
<a href='#responsibilities' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='responsibilities'>Responsibilities</h2>

<p>By default the central is in control and initiates messages. The central must offer the peripheral a turn to send it&rsquo;s messages by sending TakeTurn messages. See the flow examples below to see how the message exchange works.</p>
<a href='#messages' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='messages'>Messages</h2>
<a href='#peer-info' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='peer-info'>Peer Info</h3>

<p>The peer info message contains mtu and window size. When first connected the peripheral sends a peer info message with it&rsquo;s mtu and window size to the central. The central must accept the mtu and window sizes for sending and receiving messages.</p>
<a href='#peer-info-exchange-examples' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h5 id='peer-info-exchange-examples'>Peer Info Exchange Examples</h5>

<p>Peripheral sends peer info, and central accepts.</p>

<table><thead>
<tr>
<th style="text-align: right">Central</th>
<th style="text-align: left">Peripheral</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: right"></td>
<td style="text-align: left">&lt;- PeerInfo</td>
</tr>
<tr>
<td style="text-align: right">Ack -&gt;</td>
<td style="text-align: left"></td>
</tr>
</tbody></table>
<a href='#take-turn-message' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='take-turn-message'>Take Turn Message</h3>

<p>Each peer, the central and peripheral, require a turn to send it&rsquo;s own queued messages. By default the central is in control, and must offer the peripheral it&rsquo;s turn to send it&rsquo;s messages.</p>

<p>If a peripheral accepts and takes control, it can send it&rsquo;s own queued messages, and must offer the turn back to the central.</p>

<p>When the central receives a take turn message it is required to take control back. If it has no messages to send then it must continue to send take turn messages to the peripheral.</p>
<a href='#take-turn-message-examples' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h5 id='take-turn-message-examples'>Take Turn Message Examples</h5>

<p>The central offers a turn to the peripheral, because the peripheral has messages it accepts and takes control.</p>

<table><thead>
<tr>
<th style="text-align: right">Central</th>
<th style="text-align: left">Peripheral</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: right">TakeTurn -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right"></td>
<td style="text-align: left">&lt;- Ack</td>
</tr>
</tbody></table>

<p>The central offers a turn to the peripheral, but the peripheral doesn&rsquo;t have any messages to send to it responds with a take turn message that the central must accept.</p>

<table><thead>
<tr>
<th style="text-align: right">Central</th>
<th style="text-align: left">Peripheral</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: right">TakeTurn -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right"></td>
<td style="text-align: left">&lt;- Take Turn</td>
</tr>
<tr>
<td style="text-align: right">Ack -&gt;</td>
<td style="text-align: left"></td>
</tr>
</tbody></table>
<a href='#new-messages' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='new-messages'>New Messages</h3>

<p>Transferring messages between peers must first be agreed upon. New message requests indicate to the central and peripheral that they should set their internal state to start sending, or start receiving packets.</p>
<a href='#new-message-examples' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h5 id='new-message-examples'>New Message Examples</h5>

<p>The central initiates a new message, the peripheral accepts.</p>

<table><thead>
<tr>
<th style="text-align: right">Central</th>
<th style="text-align: left">Peripheral</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: right">NewMessage -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right"></td>
<td style="text-align: left">&lt;- Ack</td>
</tr>
</tbody></table>
<a href='#data-messages' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h3 id='data-messages'>Data Messages</h3>

<p>Once a new message has been acknowledged, the peer can start sending data packets.</p>
<a href='#data-message-examples' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h5 id='data-message-examples'>Data Message Examples</h5>

<p>Sending data messages happens in two ways.</p>

<table><thead>
<tr>
<th style="text-align: right">Central</th>
<th style="text-align: left">Peripheral</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: right">Data -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right">Data -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right">Data -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right">EndPart -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right"></td>
<td style="text-align: left">&lt;- Ack</td>
</tr>
<tr>
<td style="text-align: right">Data -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right">Data -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right">Data -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right">EndMessage -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right"></td>
<td style="text-align: left">&lt;- Ack</td>
</tr>
</tbody></table>
<a href='#resend-control-flow' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h4 id='resend-control-flow'>Resend Control Flow</h4>

<table><thead>
<tr>
<th style="text-align: right">Central</th>
<th style="text-align: left">Peripheral</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: right">NewMessage -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right"></td>
<td style="text-align: left">&lt;- Ack</td>
</tr>
<tr>
<td style="text-align: right">Data -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right">Data -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right">End Message -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right"></td>
<td style="text-align: left">&lt;- Resend</td>
</tr>
<tr>
<td style="text-align: right">Data -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right">End Message -&gt;</td>
<td style="text-align: left"></td>
</tr>
<tr>
<td style="text-align: right"></td>
<td style="text-align: left">&lt;- Ack</td>
</tr>
</tbody></table>
<a href='#aborting' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='aborting'>Aborting</h2>

<p>Aborting happens when there&rsquo;s an internal inconsistency on either side. Abort simply means reset the current message if any to prepare to receive more data, or send more data.</p>

<p>If there&rsquo;s currently no message being transferred, then the peers must completely reset, and start at the PeerInfo negotiation step.</p>
<a href='#complete-message-exchange-examples' class='anchor' aria-hidden=true><span class="header-anchor"></span></a><h2 id='complete-message-exchange-examples'>Complete Message Exchange Examples</h2>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; 2016 <a class="link" href="" target="_blank" rel="external"></a>. All rights reserved. (Last updated: 2016-09-11)</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.7.0</a>, a <a class="link" href="http://realm.io" target="_blank" rel="external">Realm</a> project.</p>
    </section>
  </body>
</div>
</html>
